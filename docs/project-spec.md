# MKV→MP4 在线转换工具（mkvamp4.com）项目开发文档  
**版本**：v1.0（2025-10-06）  
**维护人**：项目负责人 / AI 协作者  
**默认语言**：西班牙语（面向用户），内部文档为中文 + 英文术语  
**用途**：为多次对话或多位协作者（尤其是 AI）提供统一上下文，避免重复解释。

---

## 0. 如何使用本文档
- 任何需求、设计或实现变更都需在本文档中更新，以保持团队/AI 上下文一致。
- 如需补充细节，可在文档末尾的“变更记录”处添加条目。
- 用户在不同对话窗口调用 AI 时，可把本文档当作“规范源”，确保回答一致。

---

## 1. 产品概述
- **一句话定位**：一个专注于 MKV → MP4 转换的单页在线工具，默认西班牙语界面，同时提供 EN/JA/FR/DE 切换。
- **目标用户**
  - 想要快速、无门槛地把 MKV 转成 MP4 的普通用户（默认设置）。
  - 需要控制字幕/分辨率/音频的稍高级用户（使用“高级设置”折叠面板）。
- **核心卖点**
  1. 多语言 + 西语默认，提高拉美/西语市场 SEO 和转化。
  2. 字幕处理能力：软字幕保留；硬字幕烧录；删除字幕；支持外挂字幕。
  3. 极简单页流程：上传 → 选择设置 → 转换 → 下载。

---

## 2. 项目范围与不在范围
- **在范围**
  - 单文件上传（MKV），单文件下载（MP4）。
  - 前端单页应用（Next.js）+ 后端 API + 后台转码服务。
  - 基于 FFmpeg 的字幕/音视频处理。
  - 基本 SEO/性能要求，使页面具备上线潜力。
- **不在范围（v1.0）**
  - 批量上传、批量转换、批量下载。
  - 用户账户、历史记录、云存储归档。
  - 复杂视频剪辑或格式转换（仅 MKV → MP4）。
  - OCR/字幕翻译、AI 生成字幕等高级功能（列入未来规划）。

---

## 3. 用户场景 & 关键流程
1. **普通用户**
   - 上传 MKV → 保持默认设置（音视频 copy & 软字幕保留）→ 等待进度 → 下载 MP4。
2. **字幕敏感用户**
   - 上传 MKV → 展开高级设置 → 选择“烧录硬字幕”或“删除字幕”，或上传外挂字幕 → 转换 → 下载。
3. **多语言访问者**
   - 根据浏览器语言自动切西语；可手动切换 EN/JA/FR/DE。
   - 期望 FAQ/提示文本同样多语言化。

---

## 4. 功能需求（FR）
| 功能模块 | 描述 | 关键点 |
|----------|------|--------|
| 文件上传 | 拖拽/点击上传单个 MKV | 限定扩展名 .mkv；默认最大 2GB（可配置）。 |
| 转换任务创建 | 提交表单后生成任务 | 后端返回 	askId，前端轮询或 SSE。 |
| 转换状态查询 | 获取任务状态 | 状态：queued/processing/completed/ailed。 |
| 下载 MP4 | 任务完成后提供下载链接 | 链接有效期默认 1 小时；超时需重新转换。 |
| 高级设置 | 折叠面板，包含：分辨率、视频质量、帧率、音频编码/质量/声道、字幕处理、外挂字幕上传 | 默认保持原始；参数映射见附录。 |
| 字幕处理 | 软字幕保留、硬字幕、删除、外挂字幕 | 需探测字幕轨道类型及语言，处理 PGS 提示。 |
| 文案/FAQ | 支持多语言，默认西语 | 参考 SEO 策略；FAQ 重点回答字幕问题、隐私与文件删除。 |
| 隐私说明 | 单页底部展示 | 说明“处理完成即删除、无持久存储”。 |

---

## 5. 非功能需求（NFR）
- **性能**：核心转换需在 3 分钟内完成（中位数），最大文件 2GB 时不超过 10 分钟。
- **并发**：后端需支持至少 10 个并行任务（可配置 Worker 上限）。
- **可靠性**：任务失败时提供明确错误信息（字幕不兼容、转码超时等）。
- **安全**：HTTPS 全站；上传文件仅临时存储；限制恶意请求。
- **可维护性**：代码结构清晰（Next.js App Router + 后端服务目录规范）；配置化参数集中管理。
- **可访问性**：符合基本 WCAG AA（表单标签、键盘操作、颜色对比）。

---

## 6. 技术栈与架构概览
| 层级 | 选型 | 备注 |
|------|------|------|
| 前端 | Next.js 14+（App Router，内置 i18n）+ TypeScript + Tailwind 或 CSS Modules | 单页工具，SSR + SSG 结合；默认语言 es。 |
| 后端 API | Next.js API Routes（或 /app/api） | 接收上传、创建任务、查询状态。 |
| 转码 Worker | Node.js 服务或独立进程调用 FFmpeg | 可以与 Next.js Server 共机，也可独立容器。 |
| 队列/任务管理 | 简单场景下可用内存队列或轻量数据库（SQLite/Redis）；后续可扩展消息队列 | 记录任务状态、文件路径。 |
| 对象存储 | 本地临时目录或云对象存储（推荐 S3 兼容） | 区分 uploads/ 与 outputs/。 |
| CDN/传输 | 可直接由 Next.js 提供；未来可加 CDN。 |
| 日志 & 监控 | Bunyan/Pino + CloudWatch/Logtail；记录任务生命周期。 |

**数据流（简化）**
1. 前端上传文件（multipart/form-data）→ /api/upload。
2. API 保存至临时 uploads/{taskId}.mkv，创建任务记录（状态 queued）。
3. Worker 轮询/接收任务 → 运行 FFmpeg → 输出 outputs/{taskId}.mp4。
4. Worker 更新状态为 completed 或 ailed（附错误消息）。
5. 前端轮询 /api/status?taskId= 或通过 SSE 获取状态 → 提供下载 /api/download?taskId=。
6. 定时清理任务及文件（完成 ≥1h，失败 ≥24h）。

---

## 7. API 约定（草稿）
1. POST /api/upload
   - Request：multipart；字段 ile、options（JSON 字符串）。
   - Response：{ taskId: string }。
2. GET /api/status?taskId=
   - Response：{ status: 'queued'|'processing'|'completed'|'failed', progress: number (0-100), message?: string }。
3. GET /api/download?taskId=
   - 成功：返回 MP4 文件流。
   - 失败：404 / 410（超时清除）。
4. POST /api/webhooks/worker（可选）
   - Worker 回调，若不使用轮询队列。
5. 管理/健康检查（内部）：GET /api/health。

> **参数映射参考**见附录 A。

---

## 8. FFmpeg 处理策略
- **默认命令**：fmpeg -i input.mkv -c:v copy -c:a copy -c:s mov_text output.mp4
- **硬字幕**：fmpeg -i input.mkv -vf subtitles=input.mkv -c:v libx264 -crf 20 -c:a copy output.mp4
- **删除字幕**：fmpeg -i input.mkv -c:v copy -c:a copy -sn output.mp4
- **外挂字幕**：当附加 SRT/ASS 时，需添加输入并在 -vf subtitles=external.srt 或 -c:s mov_text。
- **PGS/VobSub**：提示用户选择“烧录”或提示不兼容，处理逻辑需在 Worker 中判断。

---

## 9. 文件生命周期 & 存储策略
- 上传后放入 uploads/（taskId 目录）。
- 转码输出存储在 outputs/。
- 状态记录包含：
  - 	askId
  - originalFilename
  - size
  - options（JSON）
  - status
  - createdAt, updatedAt
  - expiresAt
- 清理任务：
  - 成功任务：完成 1 小时后删除（含文件与记录）。
  - 失败任务：保留 24 小时供排查。
  - 异常文件大小或格式，立即删除并返回错误。

---

## 10. 多语言（Next.js 内置 i18n）规范
- 
ext.config.js 配置：
  `js
  i18n: {
    locales: ['es', 'en', 'ja', 'fr', 'de'],
    defaultLocale: 'es',
  }
  `
- 文案存放：/messages/{locale}.json 或 pp/[locale]/(components) 形式。
- 翻译流程：先提供西语/英语/日语官方文案，其余语种由翻译（或 AI）生成并校对。
- SEO 元信息：每个语言版本需配置 <head> 元标签、<link rel="alternate" hreflang>。
- FAQ/提示文本在 JSON 中按 key 管理，确保 AI 在生成代码时可引用。

---

## 11. UI 结构（单页）
1. **Hero 区**
   - 标题、描述（突出字幕优势）。
   - 语言切换按钮。
2. **上传区域**
   - 拖拽区域 + “或点击上传”按钮。
   - 显示文件名、大小、基本校验错误。
3. **高级设置折叠面板**
   - 视频：编码器（默认 H.264）、分辨率（原始/720p/1080p）、质量（高/中/低 → CRF 映射）、帧率（原始/30/60）。
   - 音频：编码（原始/AAC）、质量（高/中/低 → 比特率映射）、声道（原始/立体声/单声道）。
   - 字幕：处理方式、轨道选择、外挂字幕上传、PGS 提示。
4. **转换进度**
   - 任务状态条、剩余时间估计（可选）、错误提示。
5. **结果区域**
   - 成功：下载按钮、有效期提示。
   - 失败：错误原因 + 重试按钮。
6. **FAQ & 隐私声明**
   - 多语言问题列表（字幕兼容、文件删除、速度、浏览器支持）。
7. **页脚**
   - 品牌信息、版权、社交（如有）。

---

## 12. 错误处理 & 用户提示
- 上传错误：格式不支持、超过大小。
- 转码错误：字幕不兼容、FFmpeg 返回非 0、超时。
- 下载错误：超时/任务不存在。
- UI 提示需区分：红色（错误）、黄色（警告）、绿色（成功）。
- 同时记录日志：	askId + errorCode + message 便于后续排查。

---

## 13. 安全与隐私
- 全程 HTTPS。
- 上传接口限制：单 IP 速率（如 10 次/小时），防滥用。
- 使用临时存储，确保文件在删除后不可恢复。
- 禁止执行任意用户提供的 FFmpeg 参数（只允许预设选项）。
- 日志避免保存用户原始文件内容或敏感信息。
- 隐私声明包括：
  1. 文件仅用于转换，不做持久储存。
  2. 转换完成后自动删除。
  3. 不会收集个人信息（除非后续添加邮箱通知等）。

---

## 14. SEO & 内容策略（阶段三）
- 默认首页：/es/mkv-a-mp4（可配置为 /es）。
- 设置 hreflang：es, en, ja, r, de。
- 结构化数据：FAQ、HowTo。
- 博客/教程：后续可扩展 /blog，暂非 v1.0 必需。
- 关键字：mkv a mp4, convertir mkv a mp4, mkv mp4 変換, 等。
- 页面性能：LCP < 2.5s、CLS < 0.1。

---

## 15. 部署与环境
| 环境 | 目的 | 说明 |
|------|------|------|
| 本地 | 开发调试 | .env.local 配置上传目录、FFmpeg 路径。 |
| 预发 / Staging | 内部验收 | 可与生产同配置，但降低并发。 |
| 生产 | 对外服务 | 扩缩容、监控、备份清理策略到位。 |

- 部署形态：
  - 前端 Next.js + API 可部署在 Vercel/自建服务器。
  - Worker 可使用容器（Docker）+ 队列（Redis）运行。
  - 如果部署在 Vercel，需要额外服务承载长时间 FFmpeg 任务；推荐自建 Node 服务器或 AWS ECS。

---

## 16. 开发阶段规划
| 阶段 | 内容 | 产出 |
|------|------|------|
| Phase 0：环境搭建 | Next.js 项目骨架、Lint/Prettier、Tailwind、FFmpeg 安装 | 基础仓库、CI 配置 |
| Phase 1：核心转换 MVP | 上传 → 转换 → 下载（默认设置），错误处理 | 可用的单语言 Demo |
| Phase 2：高级设置 & 字幕 | 前端折叠面板、字幕轨道探测、外挂字幕 | 完整功能 Demo |
| Phase 3：i18n & SEO | 文案翻译、hreflang、FAQ | 多语言上线版本 |
| Phase 4：优化与监控 | 性能调优、日志、清理脚本 | 稳定生产版本 |

---

## 17. 测试策略
- **单元测试**：前端组件（React Testing Library），后端 API（Jest/Supertest），Worker 逻辑（转换参数）。
- **集成测试**：端到端（Playwright）模拟上传 → 下载流程（小文件）。
- **手动测试**：
  - 字幕场景：软字幕、硬字幕、PGS、外挂字幕。
  - 浏览器兼容：Chrome、Firefox、Safari（最新两个版本）。
  - 多语言切换 + SEO 元信息检查。
- **监控指标**：成功率、平均处理时间、失败原因 Top3。

---

## 18. 后续增强（可选）
- 任务进度通知（邮件/浏览器通知）。
- 更大文件支持（分片上传）。
- 其他格式支持（AVI、MOV 等）。
- 用户配置保存（localStorage）。
- 支持 AV1 输出、HDR 处理。

---

## 19. 术语表
| 术语 | 说明 |
|------|------|
| FFmpeg | 开源音视频处理命令行工具。 |
| FFprobe | FFmpeg 附带的媒体信息探测工具。 |
| 软字幕 / 硬字幕 | 软字幕作为独立轨道；硬字幕烧录进视频。 |
| PGS/VobSub | 图像型字幕格式，MP4 不兼容。 |
| CRF | Constant Rate Factor，控制视频质量的参数。 |
| hreflang | SEO 中声明页面语言和地区的标签。 |

---

## 20. 变更记录
| 日期 | 版本 | 变更内容 | 负责人 |
|------|------|----------|--------|
| 2025-10-06 | v1.0 | 初始版本 | AI 协作者 |
